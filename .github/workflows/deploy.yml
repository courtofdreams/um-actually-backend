name: Backend CI/CD Pipeline

# Trigger on push to main or pull requests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Test and Build
  test:
    name: Test and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            "fastapi>=0.121.3,<0.122.0" \
            "uvicorn>=0.38.0,<0.39.0" \
            "python-dotenv==1.0.0" \
            "pydantic>=2.12.4,<3.0.0" \
            "pydantic-settings>=2.0.0,<3.0.0" \
            "yt-dlp==2025.10.14" \
            "openai>=1.0.0,<2.0.0"
      
      - name: Verify imports and syntax
        run: |
          python -m py_compile main.py
          python -c "from main import app; print('✓ FastAPI app loaded successfully')"
      
      - name: Run basic health check
        run: |
          python -c "
          from main import app
          from fastapi.testclient import TestClient
          
          client = TestClient(app)
          response = client.get('/health')
          assert response.status_code == 200
          assert response.json()['status'] == 'healthy'
          print('✓ Health check passed')
          "
      
      # Optional: Add pytest if you have test files
      # - name: Run tests
      #   run: pytest
      
  # Job 2: Deploy to Fly.io (only on push to main)
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          # NOTE: Make sure OPENAI_API_KEY is set in Fly.io secrets:
          # Run: fly secrets set OPENAI_API_KEY=your-openai-key-here
      
      - name: Verify deployment
        run: |
          # Wait for deployment to be ready
          sleep 10
          # You can add a health check here if you want
          echo "✓ Deployment completed"

